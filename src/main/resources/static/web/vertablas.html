<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Tablas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .pagination { margin-top: 10px; }
        .pagination button { margin: 0 5px; padding: 5px 10px; }
        textarea { width: 100%; height: 100px; resize: vertical; margin-top: 5px; }
    </style>
</head>
<body class="container bg-gray-100">
<h1 class="text-2xl font-bold mb-4">Visualización de Tablas</h1>

<div class="mb-4">
    <form id="filterForm" class="flex space-x-4">
        <div>
            <label for="tableName" class="block text-sm font-medium">Seleccionar Tabla</label>
            <select id="tableName" class="border rounded p-1 w-full">
                <!-- Populated dynamically -->
            </select>
            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">Cargar</button>
            <button id="exportButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mt-2" style="display:none;">Descargar Excel</button>
        </div>
        <div>
            <label for="queryInput" class="block text-sm font-medium mt-2">Query SQL Personalizado</label>
            <textarea id="queryInput" placeholder="Escribe tu query SQL aquí (e.g., SELECT * FROM alarms LIMIT 10)" class="border rounded p-1"></textarea>
            <button id="consultQueryBtn" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 mt-2">Consultar Query</button>
        </div>
    </form>
</div>

<table class="table-auto">
    <thead>
    <tr>
        <th>Columna</th> <!-- Dinámico -->
    </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>
<div id="error" class="text-red-500" style="display:none;"></div>
<div id="pagination" class="pagination" style="display:none;"></div>

<script>
    let currentPage = 0;
    let totalPages = 0;
    let currentTableName = '';

    // Fetch tables for dropdown with absolute URL
    async function fetchTables() {
        try {
            const response = await fetch('/api/tables/data', { mode: 'cors' });
            if (!response.ok) throw new Error(`Error HTTP! estado: ${response.status}`);
            const data = await response.json();
            console.log('Tablas recibidas:', data.tables);

            const select = document.getElementById('tableName');
            select.innerHTML = '<option value="">Selecciona tabla</option>';
            if (data.tables && data.tables.length > 0) {
                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay tablas disponibles';
                option.disabled = true;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Error al cargar tablas:', error);
            document.getElementById('error').textContent = 'Error al cargar tablas: ' + error.message;
            document.getElementById('error').style.display = 'block';
        }
    }

    // Fetch and display table data with absolute URL
    async function fetchTableData(tableName, page = 0) {
        if (!tableName) return;
        currentTableName = tableName;
        const url = `/api/tables/data?tableName=${encodeURIComponent(tableName)}&page=${page}&size=50`;
        try {
            const response = await fetch(url, { mode: 'cors' });
            if (!response.ok) throw new Error(`Error HTTP! estado: ${response.status}`);
            const data = await response.json();
            console.log('Datos recibidos:', data);

            const tableBody = document.getElementById('tableBody');
            const errorDiv = document.getElementById('error');
            const paginationDiv = document.getElementById('pagination');
            const exportButton = document.getElementById('exportButton');

            tableBody.innerHTML = '';
            errorDiv.style.display = 'none';
            paginationDiv.style.display = 'none';
            exportButton.style.display = 'none';

            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
            } else if (data.data && data.data.length > 0) {
                const columns = Object.keys(data.data[0]);
                const thead = document.querySelector('thead tr');
                thead.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                    tableBody.appendChild(tr);
                });

                currentPage = data.page;
                const total = data.total || 0;
                totalPages = Math.ceil(total / 50);
                updatePagination();
                exportButton.style.display = 'inline-block';
            } else {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="100%">No se encontraron datos</td>';
                tableBody.appendChild(tr);
            }
        } catch (error) {
            console.error('Error al cargar datos:', error);
            document.getElementById('error').textContent = 'Error al cargar datos: ' + error.message;
            document.getElementById('error').style.display = 'block';
        }
    }

    // Actualizar controles de paginación
    function updatePagination() {
        const paginationDiv = document.getElementById('pagination');
        paginationDiv.innerHTML = '';
        paginationDiv.style.display = totalPages > 1 ? 'block' : 'none';

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Anterior';
        prevButton.disabled = currentPage === 0;
        prevButton.addEventListener('click', () => fetchTableData(currentTableName, currentPage - 1));
        paginationDiv.appendChild(prevButton);

        for (let i = 0; i < totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i + 1;
            pageButton.disabled = i === currentPage;
            pageButton.addEventListener('click', () => fetchTableData(currentTableName, i));
            paginationDiv.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Siguiente';
        nextButton.disabled = currentPage === totalPages - 1;
        nextButton.addEventListener('click', () => fetchTableData(currentTableName, currentPage + 1));
        paginationDiv.appendChild(nextButton);
    }

    // Manejar descarga de Excel
    document.getElementById('exportButton').addEventListener('click', () => {
        if (currentTableName) {
            window.location.href = `/api/tables/export?tableName=${encodeURIComponent(currentTableName)}`;
        }
    });

    // Handle form submission para cargar tabla
    document.getElementById('filterForm').addEventListener('submit', event => {
        event.preventDefault();
        const tableName = document.getElementById('tableName').value;
        fetchTableData(tableName, 0);
    });

    // Ejecutar consulta personalizada
    document.getElementById('consultQueryBtn').addEventListener('click', async () => {
        const query = document.getElementById('queryInput').value.trim();
        if (!query) {
            alert('Escribe un query SQL');
            return;
        }

        try {
            const response = await fetch('/api/query/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Error en el servidor');
            }
            const data = await response.json();
            displayQueryResults(data.data);
            document.getElementById('error').style.display = 'none';
            document.getElementById('pagination').style.display = 'none'; // Ocultar paginación para queries
            document.getElementById('exportButton').style.display = 'none'; // Ocultar botón de exportación
        } catch (error) {
            console.error('Error al ejecutar query:', error);
            document.getElementById('error').textContent = 'Error al ejecutar query: ' + error.message;
            document.getElementById('error').style.display = 'block';
        }
    });

    // Mostrar resultados de consulta personalizada
    function displayQueryResults(data) {
        const tableBody = document.getElementById('tableBody');
        const thead = document.querySelector('thead tr');
        tableBody.innerHTML = '';

        if (data && data.length > 0) {
            const columns = Object.keys(data[0]);
            thead.innerHTML = columns.map(col => `<th>${col}</th>`).join('');

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                tableBody.appendChild(tr);
            });
        } else {
            thead.innerHTML = '<th>No se encontraron datos</th>';
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>No se encontraron datos</td>';
            tableBody.appendChild(tr);
        }
    }

    // Load tables on page load
    document.addEventListener('DOMContentLoaded', fetchTables);
</script>
</body>
</html>